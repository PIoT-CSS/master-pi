{% extends "layouts/dashboard-layout.html" %}

{% block container %}

<body>
  <h1 class="title">TEST GOOGLE CALENDAR API</h1>

  <!--Add buttons to initiate auth sequence and sign out-->
  <button id="authorize_button" class="button is-info" style="display: none;">Sign in to Google Calendar</button>
  <!-- <button id="signout_button" class="button is-danger" style="display: none;">Sign Out (doesn't work, not quite needed)</button> -->

  <button id="add_event_button" class="button is-info" style="display: none;" onClick='addEvent()'>Add Test Event (check console for details)</button>
  <p id="event_id" style="display: none;"></p>
  <button id="delete_event_button" class="button is-danger" style="display: none;" onClick='deleteEvent()'>Delete Test Event</button>

  <script type="text/javascript">
    // Client ID and API key from the Developer Console
    var CLIENT_ID = '323937621454-r3ij4jlr46e981tldrm8d16h7moeiqct.apps.googleusercontent.com';
    var API_KEY = 'AIzaSyAsSp6r3fxtglJhXfyV_UsiVTU-8h-t5Vc';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    var SCOPES = "https://www.googleapis.com/auth/calendar";

    var authorizeButton = document.getElementById('authorize_button');
    // var signoutButton = document.getElementById('signout_button');
    var addEventButton = document.getElementById('add_event_button');
    var deleteEventButton = document.getElementById('delete_event_button');
    var eventId = document.getElementById('event_id');

    /**
     *  On load, called to load the auth2 library and API client library.
     */
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        authorizeButton.onclick = handleAuthClick;
        // signoutButton.onclick = handleSignoutClick;
      }, function (error) {
        appendPre(JSON.stringify(error, null, 2));
      });
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        // signoutButton.style.display = 'block';
        addEventButton.style.display = 'block';
      } else {
        authorizeButton.style.display = 'block';
        // signoutButton.style.display = 'none';
        addEventButton.style.display = 'none';
      }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }

    // /**
    //  *  Sign out the user upon button click.
    //  */
    // function handleSignoutClick(event) {
    //   gapi.auth2.getAuthInstance().signOut();
    // }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
      var pre = document.getElementById('content');
      var textContent = document.createTextNode(message + '\n');
      pre.appendChild(textContent);
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */
     function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        // signoutButton.style.display = 'block';
        addEventButton.style.display = 'block';
        console.log(sampleEvent);
      } else {
        addEventButton.style.display = 'none';
        authorizeButton.style.display = 'block';
        // signoutButton.style.display = 'none';
      }
    }

    // This is the resource we will pass while calling api function
    var sampleEvent = {
      "summary": "Carshare Test",
      'description': 'Wow that worked.',
      "location": "House Share Melbourne (King St/Walsh St)",
      'start': {
        'dateTime': '2020-05-28T09:00:00-07:00',
        'timeZone': 'Australia/Melbourne'
      },
      'end': {
        'dateTime': '2020-05-28T17:00:00-07:00',
        'timeZone': 'Australia/Melbourne'
      },
    };

    function addEvent() {
      gapi.client.calendar.events.insert
        ({
          'calendarId': 'primary',
          // calendar ID which id of Google Calendar where you are creating events. this can be copied from your Google Calendar user view.
          "resource": sampleEvent 	// above resource will be passed here
        }).then(function (response) {
          eventId.innerHTML = response.result.id;
          console.log("EVENT ID (USED TO REMOVE FROM CALENDAR): " + eventId.innerHTML);
          eventId.style.display = 'block';
          deleteEventButton.style.display = 'block';
          addEventButton.style.display = 'none';
          alert("Event added");
        });
    }

    function deleteEvent() {
      gapi.client.calendar.events.delete
        ({
          'calendarId': 'primary',
          // calendar ID which id of Google Calendar where you are creating events. this can be copied from your Google Calendar user view.
          "eventId": eventId.innerHTML 	// above resource will be passed here
        }).then(function (response) {
          alert("Event removed!");
          eventId.style.display = 'none';
          deleteEventButton.style.display = 'none';
          addEventButton.style.display = 'block';
        });
    }

  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
</body>


{% endblock %}